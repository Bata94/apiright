# APIRight

A modern Go framework that transforms sqlc-generated structs into ready-to-use REST APIs with full type safety using Go generics.

## Features

- 🚀 **Zero-config CRUD APIs** - Automatically generate REST endpoints from your database models
- 🔒 **Type Safety** - Full type safety with Go generics (no more `interface{}`)
- 🔄 **Model Transformation** - Built-in transformation layer between database and API models
- 🛠️ **Middleware Support** - CORS, logging, authentication, and custom middleware
- 📊 **Database Agnostic** - Works with PostgreSQL, SQLite, and other SQL databases
- 🎯 **sqlc Integration** - Designed to work seamlessly with sqlc-generated code

## Quick Start

### Using Nix (Recommended)

```bash
# Enter the development shell
nix develop

# Install dependencies
go mod tidy

# Run the example
go run examples/basic/main.go
```

### Manual Setup

```bash
# Install Go 1.23+
# Install dependencies
go mod tidy

# Run the example
go run examples/basic/main.go
```

## Basic Usage

### 1. Define Your Models

```go
// User represents the database model (generated by sqlc)
type User struct {
    ID       int64  `db:"id" json:"id"`
    Name     string `db:"name" json:"name"`
    Email    string `db:"email" json:"email"`
    Password string `db:"password" json:"-"` // Hidden from JSON
}

// Implement the Model interface
func (u *User) GetID() int64 { return u.ID }
func (u *User) SetID(id int64) { u.ID = id }

// UserAPI represents the API model (what clients see)
type UserAPI struct {
    ID    int64  `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
    // Note: Password is excluded for security
}
```

### 2. Create Your App

```go
package main

import (
    "database/sql"
    "github.com/bata94/apiright/pkg/apiright"
    "github.com/bata94/apiright/pkg/transform"
    _ "github.com/mattn/go-sqlite3"
)

func main() {
    // Setup database
    db, _ := sql.Open("sqlite3", "app.db")
    defer db.Close()

    // Create app with configuration
    app := apiright.NewWithOptions(
        apiright.WithConfig(&apiright.Config{
            Host:       "0.0.0.0",
            Port:       "8080",
            APIVersion: "v1",
            EnableCORS: true,
        }),
        apiright.WithDatabase(db),
    )

    // Register CRUD endpoints with transformation
    transformer := transform.NewBiDirectionalTransformer[*User, *UserAPI]()
    apiright.RegisterCRUDWithTransform[*User, *UserAPI](
        app, "/users", "users", transformer,
    )

    // Start the server
    app.Start()
}
```

### 3. Use Your API

The framework automatically generates these endpoints:

```bash
# Create a user
curl -X POST http://localhost:8080/v1/users \
  -H "Content-Type: application/json" \
  -d '{"name":"John Doe","email":"john@example.com"}'

# Get all users
curl http://localhost:8080/v1/users

# Get user by ID
curl http://localhost:8080/v1/users/1

# Update user
curl -X PUT http://localhost:8080/v1/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name":"John Smith","email":"john.smith@example.com"}'

# Delete user
curl -X DELETE http://localhost:8080/v1/users/1
```

## Advanced Features

### Custom Field Mapping

```go
transformer := transform.NewBiDirectionalTransformer[*User, *UserAPI]().
    WithFieldMapping("user_name", "name").
    WithFieldMapping("email_address", "email")
```

### Custom Middleware

```go
app.Use(apiright.AuthMiddleware(map[string]bool{
    "secret-token": true,
}))

app.Use(apiright.RecoveryMiddleware())
```

### Direct CRUD (No Transformation)

```go
// For models that don't need transformation
apiright.RegisterCRUD[*Product](app, "/products", "products")
```

## Type Safety Improvements

This version eliminates all `interface{}` usage from the previous version:

- ✅ **Generic CRUD Operations** - `Repository[T Model]` and `CRUDHandler[T Model]`
- ✅ **Type-Safe Transformations** - `Transformer[TSource, TTarget]`
- ✅ **Strongly Typed Middleware** - No more `interface{}` parameters
- ✅ **Compile-Time Safety** - Catch type errors at compile time, not runtime

## Configuration

```go
type Config struct {
    Host         string // Server host (default: "0.0.0.0")
    Port         string // Server port (default: "8080")
    Database     string // Database type (default: "sqlite3")
    DSN          string // Database connection string
    APIVersion   string // API version prefix (default: "v1")
    Debug        bool   // Enable debug mode
    EnableCORS   bool   // Enable CORS middleware
    EnableLogger bool   // Enable logging middleware
}
```

## Development

### With Nix

```bash
# Enter development shell
nix develop

# Run with hot reload
air

# Run tests
go test ./...

# Build
go build ./...
```

### Without Nix

Ensure you have:
- Go 1.23+
- SQLite3 development libraries
- PostgreSQL client libraries (if using PostgreSQL)

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   HTTP Client   │───▶│   APIRight App   │───▶│    Database     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  Transform Layer │
                    │  (DB ↔ API)      │
                    └──────────────────┘
```

- **HTTP Layer**: Handles routing, middleware, and HTTP concerns
- **Transform Layer**: Converts between database models and API models
- **CRUD Layer**: Provides generic database operations
- **Database Layer**: Your existing sqlc-generated code

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes with proper type safety
4. Add tests
5. Submit a pull request

## License

MIT License - see LICENSE file for details.